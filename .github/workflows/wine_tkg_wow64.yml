name: Compile Wine TkG wow64 (auto)

permissions:
  contents: write
  packages: write

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Wine release tag（可选，例如：wine-9.22，不填则使用最新tag）"
        required: false
        type: string
      tkg:
        description: "Wine TkG仓库分支"
        required: false
        type: string
      enable_mf:
        description: "启用 Proton MF 解码"
        required: false
        type: boolean
        default: false
  schedule:
    - cron: "0 1 * * *" # 每日 01:00 检查一次（UTC 时间）

jobs:
  BCC:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 使用 cache 保存上一次看到的 tag
      - name: Restore last wine release tag from cache
        id: cache-tag
        uses: actions/cache@v4
        with:
          path: .wine_last_tag
          key: wine-last-tag

      - name: Get latest wine tag
        id: wine-mirror
        env:
          CUSTOM_TAG: ${{ github.event.inputs.tag }}
          TKG_VER: ${{ github.event.inputs.tkg }}
          ENABLE_MF: ${{ github.event.inputs.enable_mf }}
        run: |
          if [ -n "$CUSTOM_TAG" ]; then
            echo "Use custom tag from manual dispatch: $CUSTOM_TAG"
            latest_tag="$CUSTOM_TAG"
          else
            # https://github.com/wine-mirror/wine
            latest_tag=$(git ls-remote --tags https://github.com/wine-mirror/wine.git | grep -Ev '\^\{\}$' | sed 's/.*\///' | grep -E '^wine-[0-9]+\.[0-9]+.*$' | sort -V | tail -n 1)
          fi
          [[ -z "$lastest_tag" ]] || exit 1
          echo "Latest Wine tag: $latest_tag"
          echo "$latest_tag" > .wine_current_tag
          echo "tag=$latest_tag" >> "$GITHUB_OUTPUT"
          echo "enable_mf=$ENABLE_MF" >> "$GITHUB_OUTPUT"

      - name: Read last saved tag (if any)
        id: last
        run: |
          if [ -f .wine_last_tag ]; then
            last_tag=$(cat .wine_last_tag)
          else
            last_tag=""
          fi
          echo "Last Wine tag: $last_tag"
          echo "tag=$last_tag" >> "$GITHUB_OUTPUT"

      - name: Compare tags and decide whether to run build
        id: need_build
        env:
          EVENT_NAME: ${{ github.event_name }}
        run: |
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            # 手动触发时无论是否与上次相同 tag 都执行
            echo "Manual dispatch, force build."
            echo "new_release=true" >> "$GITHUB_OUTPUT"
          else
            if [ "${{ steps.wine-mirror.outputs.tag }}" != "${{ steps.last.outputs.tag }}" ]; then
              echo "new_release=true" >> "$GITHUB_OUTPUT"
            else
              echo "new_release=false" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Get Wine tag
        id: wine_tag
        if: steps.need_build.outputs.new_release == 'true'
        run: |
          if [[ ${{ github.event.inputs.enable_mf == true }} ]]; then
            echo "PKG_NAME=mf" >> $GITHUB_OUTPUT
          else
            echo "PKG_NAME=mfdxgi" >> $GITHUB_OUTPUT
          fi
          wine_tag=${{ steps.wine-mirror.outputs.tag }} # wine-10.0
          echo "wine_tag=${{ steps.wine-mirror.outputs.tag }}" >> $GITHUB_OUTPUT
          wine_ver="${wine_tag#wine-}"   # 10.0
          echo="wine_ver=$wine_ver" >> $GITHUB_OUTPUT

      # 只有检测到新 release（或手动触发）才执行你的脚本
      - name: Clone project
        if: steps.need_build.outputs.new_release == 'true'
        run: |
          echo "Using Wine tag: ${{ steps.wine_tag.outputs.wine_tag }}"

          cat > ~/.gitconfig << EOF
          [fetch]
            parallel = `nproc`
          [submodule]
            fetchJobs = `nproc`
          EOF

          # git clone -b "${{ steps.wine_tag.outputs.wine_tag }}" https://github.com/wine-mirror/wine wine-src
          if [[ -z $TKG_VER ]]; then
            git clone https://github.com/Frogging-Family/wine-tkg-git.git
          else
            git clone -b $TKG_VER https://github.com/Frogging-Family/wine-tkg-git.git
          fi
          cd /tmp

          aria2c -s$(nproc) -x$(nproc) https://github.com/Waim908/BCC/releases/download/wine-bcc-latest/wine-bcc.tar.xz

          sudo tar xf wine-bcc.tar.xz || exit 1
          # sudo mv $GITHUB_WORKSPACE/wine-src archlinux/tmp/
          sudo mv $GITHUB_WORKSPACE/wine-tkg-git archlinux/tmp/
          sudo cp -r -p $GITHUB_WORKSPACE/ archlinux/tmp/

          # 为 rootfs 内的 ccache 目录预留位置（/tmp/archlinux/root/.cache/ccache）
          sudo mkdir -p archlinux/root/.cache/ccache
          sudo chmod -R 777 archlinux/root/.cache

          cat > build-wine.sh << EOF
          #!/bin/bash
          [[ -d /tmp/wine-termux ]] || exit 1
          export USE_CACHE=1
          export ENABLE_PROTON_MF=${{ github.event.inputs.enable_mf }}

          cd /tmp/wine-tkg-git/wine-tkg-git/
          bash -x /tmp/wine-termux/patch.sh wine-tkg-auto ${{ steps.wine_tag.outputs.wine_tag }} /tmp/wine-tkg-git/wine-tkg-git/wine-tkg-userpatches || exit 1
          bash -x /tmp/wine-termux/set-tkg-cfg.sh ${{ steps.wine_tag.outputs.wine_tag }} /tmp/wine-tkg-git/wine-tkg-git || exit 1
          echo '_ci_build="true"' >> customization.cfg
          yes | ./non-makepkg-build.sh || exit 1
          cd /tmp

          output="$(ls /tmp/output/*/ 2>/dev/null)"
          [[ -z $output ]] || exit 1

          cd /tmp/output/

          tar -I 'xz -T$(nproc)' -cvf /tmp/wine-${{ steps.wine_tag.outputs.wine_tag }}-${{ steps.wine_tag.outputs.PKG_NAME }}-tkg-stg-ge.tar.xz */
          EOF

          sudo chmod 777 build-wine.sh
          sudo cp -r -p build-wine.sh archlinux/bin/

      - name: Cache ccache directory in rootfs
        if: steps.need_build.outputs.new_release == 'true'
        uses: actions/cache@v4
        with:
          path: /tmp/archlinux/root/.cache/ccache
          key: wine-tkg-ccache-${{ runner.os }}-x86_64

      - name: Compile Use BCC
        if: steps.need_build.outputs.new_release == 'true'
        run: |
          cd /tmp
          bash $GITHUB_WORKSPACE/mount.sh archlinux mount
          sudo chroot archlinux bash -x "/bin/build-wine.sh"
          bash $GITHUB_WORKSPACE/mount.sh archlinux unmount

      - name: Upload Source
        if: steps.need_build.outputs.new_release == 'true'
        run: |
          cd /tmp/archlinux/tmp/wine-tkg/src/wine-git/
          cp -r -p /tmp/archlinux/tmp/output/*/share/wine/wine-tkg-config.txt .
          rm -rf .git

          git init
          git checkout -b ${{ steps.wine_tag.outputs.wine_ver }}-${{ steps.wine_tag.outputs.PKG_NAME }}

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .

          git commit -m "Upload ${{ steps.wine_tag.outputs.wine_tag }}"

          git remote add origin https://${{ secrets.GITHUB_TOKEN }}@github.com/Waim908/wine-termux.git

          git push -u origin main --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Cache
        if: steps.need_build.outputs.new_release == 'true'
        uses: actions/cache@v4
        with:
          path: /tmp/archlinux/root/.cache/ccache
          key: wine-tkg-ccache-${{ runner.os }}-x86_64

      - name: Create GitHub Release
        if: steps.need_build.outputs.new_release == 'true'
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.wine_tag.outputs.wine_ver }}-${{ steps.wine_tag.outputs.PKG_NAME }}
          name: Wine TkG Stg GE ${{ steps.wine_tag.outputs.wine_tag }} # 例如：Proton Wine 10.0-4
          body: |
            源码修改查看此仓库补丁。
          files: /tmp/archlinux/tmp/wine-${{ steps.wine_tag.outputs.wine_tag }}-${{ steps.wine_tag.outputs.PKG_NAME }}-tkg-stg-ge.tar.xz

      # 更新缓存里的 last_tag（保持和 latest 对齐）
      - name: Save current tag to cache file
        if: steps.need_build.outputs.new_release == 'true'
        run: |
          cp .wine_current_tag .wine_last_tag

      - name: Update cache with new tag
        if: steps.need_build.outputs.new_release == 'true'
        uses: actions/cache@v4
        with:
          path: .wine_last_tag
          key: wine-last-tag
